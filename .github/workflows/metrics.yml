name: metrics

on:
  schedule:
    - cron: "0 0 * * *"
  push:
    branches:
      - main
      - master
    paths-ignore:
      - "assets/metrics.svg"
      - "assets/highlights.svg"
  workflow_dispatch:
  repository_dispatch:
    types:
      - metrics_update

permissions:
  contents: write

concurrency:
  group: metrics-${{ github.ref }}
  cancel-in-progress: true

jobs:
  github-metrics:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Check METRICS_TOKEN
        id: token
        shell: bash
        run: |
          if [[ -n "${{ secrets.METRICS_TOKEN }}" ]]; then
            echo "has_token=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_token=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout repository
        if: steps.token.outputs.has_token == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate metrics
        if: steps.token.outputs.has_token == 'true'
        uses: lowlighter/metrics@latest
        with:
          filename: assets/metrics.svg
          token: ${{ secrets.METRICS_TOKEN }}
          committer_token: ${{ github.token }}
          output_action: commit

          user: blueokanna
          template: classic
          base: header, community, repositories
          base_indepth: yes

          repositories_affiliations: owner
          repositories_forks: no
          repositories: 200
          repositories_batch: 50

          config_timezone: Asia/Shanghai
          config_display: large

          plugin_languages: yes
          plugin_languages_details: bytes-size, percentage
          plugin_languages_limit: 5
          plugin_languages_other: yes

          plugin_isocalendar: yes
          plugin_isocalendar_duration: half-year

      - name: Generate highlights (recently updated, then stars)
        if: steps.token.outputs.has_token == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const { request } = require('@octokit/request');

            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
            const login = 'blueokanna';
            const perPage = 100;

            const dataRequest = request.defaults({
              headers: {
                authorization: `bearer ${process.env.METRICS_TOKEN}`,
              },
            });

            async function fetchAllRepos() {
              let after = null;
              const repos = [];
              while (true) {
                const query = `
                  query($login: String!, $perPage: Int!, $after: String) {
                    user(login: $login) {
                      repositories(first: $perPage, after: $after, ownerAffiliations: OWNER, isFork: false, orderBy: {field: PUSHED_AT, direction: DESC}) {
                        pageInfo { hasNextPage endCursor }
                        nodes {
                          name
                          description
                          url
                          stargazerCount
                          forkCount
                          pushedAt
                          isArchived
                          isTemplate
                        }
                      }
                    }
                  }
                `;
                const { data } = await dataRequest('POST /graphql', {
                  query,
                  variables: { login, perPage, after },
                });
                const page = data.user.repositories.nodes || [];
                repos.push(...page);
                const { hasNextPage, endCursor } = data.user.repositories.pageInfo;
                if (!hasNextPage) break;
                after = endCursor;
              }
              return repos;
            }

            function escapeXml(s) {
              return String(s ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
            }

            function fmtRepoLine(idx, r) {
              const name = `${login}/${r.name}`;
              const stars = r.stargazerCount ?? 0;
              const forks = r.forkCount ?? 0;
              const pushed = r.pushedAt ? new Date(r.pushedAt).toISOString().slice(0, 10) : 'n/a';
              return `#${idx} ${name}  ★${stars}  ⑂${forks}  push:${pushed}`;
            }

            const repos = await fetchAllRepos();
            const sorted = repos.sort((a, b) => {
              const ta = a.pushedAt ? Date.parse(a.pushedAt) : 0;
              const tb = b.pushedAt ? Date.parse(b.pushedAt) : 0;
              if (tb !== ta) return tb - ta; // recent first
              const sa = a.stargazerCount ?? 0;
              const sb = b.stargazerCount ?? 0;
              return sb - sa; // then stars
            }).slice(0, 5);

            const lines = [
              'SYSTEM:: featured (recent → stars)',
              ...sorted.map((r, i) => fmtRepoLine(i + 1, r)),
            ];

            const width = 960;
            const height = 190;
            const padX = 28;
            const startY = 54;
            const lineH = 28;
            const svg = `<?xml version="1.0" encoding="UTF-8"?>
            <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
              <defs>
                <linearGradient id="g" x1="0" y1="0" x2="1" y2="0">
                  <stop offset="0" stop-color="#22d3ee" stop-opacity="0.9" />
                  <stop offset="1" stop-color="#a78bfa" stop-opacity="0.9" />
                </linearGradient>
                <filter id="s" x="-20%" y="-20%" width="140%" height="140%">
                  <feDropShadow dx="0" dy="0" stdDeviation="6" flood-color="#000" flood-opacity="0.35" />
                </filter>
              </defs>
              <rect x="14" y="14" width="${width - 28}" height="${height - 28}" rx="14" fill="#0d1117" stroke="url(#g)" stroke-width="1.6" filter="url(#s)" />
              <text x="${padX}" y="38" fill="#22d3ee" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, monospace" font-size="16" font-weight="700">$ cat highlights.txt</text>
              ${lines.map((t, i) => {
                const y = startY + i * lineH;
                const color = i === 0 ? '#c9d1d9' : '#9ca3af';
                return `<text x="${padX}" y="${y}" fill="${color}" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, monospace" font-size="14">${escapeXml(t)}</text>`;
              }).join('\n')}
            </svg>`;

            const outPath = path.join(process.env.GITHUB_WORKSPACE || '.', 'assets', 'highlights.svg');
            fs.mkdirSync(path.dirname(outPath), { recursive: true });
            fs.writeFileSync(outPath, svg, 'utf8');

            // Commit via Contents API so it works without checkout
            const contentB64 = Buffer.from(svg, 'utf8').toString('base64');
            let sha;
            try {
              const existing = await github.rest.repos.getContent({ owner, repo, path: 'assets/highlights.svg' });
              sha = existing.data.sha;
            } catch (e) {
              sha = undefined;
            }

            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path: 'assets/highlights.svg',
              message: 'chore: update highlights.svg',
              content: contentB64,
              sha,
            });

      - name: Bump README cache (images)
        if: steps.token.outputs.has_token == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const { owner, repo } = context.repo;
            const runId = process.env.GITHUB_RUN_ID;
            const path = 'README.md';

            const current = await github.rest.repos.getContent({ owner, repo, path });
            const decoded = Buffer.from(current.data.content, 'base64').toString('utf8');

            const bump = (content, name) => {
              const re = new RegExp(`assets/${name}\\.svg(?:\\?v=\\d+)?`, 'g');
              return content.replace(re, `assets/${name}.svg?v=${runId}`);
            };

            let updated = bump(decoded, 'highlights');
            updated = bump(updated, 'metrics');

            if (updated === decoded) {
              core.info('README already up to date; skipping.');
              return;
            }

            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path,
              message: `chore: refresh README cache (${runId})`,
              content: Buffer.from(updated, 'utf8').toString('base64'),
              sha: current.data.sha,
            });

      - name: Placeholder
        if: steps.token.outputs.has_token != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');

            const width = 960;
            const height = 190;
            const svg = `<?xml version="1.0" encoding="UTF-8"?>
            <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
              <defs>
                <linearGradient id="g" x1="0" y1="0" x2="1" y2="0">
                  <stop offset="0" stop-color="#22d3ee" stop-opacity="0.9" />
                  <stop offset="1" stop-color="#a78bfa" stop-opacity="0.9" />
                </linearGradient>
              </defs>
              <rect x="14" y="14" width="${width - 28}" height="${height - 28}" rx="14" fill="#0d1117" stroke="url(#g)" stroke-width="1.6" />
              <text x="28" y="38" fill="#22d3ee" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, monospace" font-size="16" font-weight="700">$ cat highlights.txt</text>
              <text x="28" y="74" fill="#9ca3af" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, monospace" font-size="14">METRICS_TOKEN is not set.</text>
              <text x="28" y="102" fill="#9ca3af" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, monospace" font-size="14">Add it in: Settings → Secrets and variables → Actions → New repository secret</text>
              <text x="28" y="130" fill="#9ca3af" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, monospace" font-size="14">Then run Actions → metrics → Run workflow</text>
            </svg>`;

            const contentB64 = Buffer.from(svg, 'utf8').toString('base64');
            let sha;
            try {
              const existing = await github.rest.repos.getContent({ owner, repo, path: 'assets/highlights.svg' });
              sha = existing.data.sha;
            } catch (e) {
              sha = undefined;
            }
            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path: 'assets/highlights.svg',
              message: 'chore: placeholder highlights.svg (missing METRICS_TOKEN)',
              content: contentB64,
              sha,
            });
